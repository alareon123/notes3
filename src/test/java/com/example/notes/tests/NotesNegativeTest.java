package com.example.notes.tests;

import com.example.notes.core.BaseApiTest;
import com.example.notes.data.TestData;
import com.example.notes.endpoints.NotesClient;
import com.example.notes.models.NoteCreateRequest;
import io.restassured.response.Response;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;

import static org.hamcrest.Matchers.notNullValue;

/**
 * НЕГАТИВНЫЕ ТЕСТЫ для заметок
 *
 * Что такое негативные тесты (Negative Tests)?
 * Это тесты, которые проверяют поведение системы при НЕПРАВИЛЬНЫХ действиях пользователя.
 * В отличие от позитивных тестов (когда всё идёт правильно), негативные тесты проверяют:
 * - Как система реагирует на некорректные данные
 * - Возвращает ли система понятные сообщения об ошибках
 * - Не падает ли сервер при неожиданных ситуациях
 * - Правильные ли HTTP-коды возвращаются при ошибках
 *
 * Цель негативных тестов:
 * - Убедиться, что API корректно обрабатывает ошибки
 * - Проверить, что пользователь получит понятное сообщение об ошибке
 * - Убедиться, что система не "ломается" при некорректных запросах
 * - Проверить правильность HTTP-кодов ответа (400 для плохого запроса, 404 для несуществующего ресурса)
 *
 * Эти тесты очень важны для качества системы, так как пользователи часто делают ошибки:
 * - Забывают заполнить обязательные поля
 * - Вводят неправильные ID
 * - Пытаются удалить то, что уже удалено
 */
@DisplayName("Notes Negative Tests") // Название группы тестов для отчёта
public class NotesNegativeTest extends BaseApiTest { // Наследуемся от базового класса

    /**
     * ТЕСТ: Создание заметки с пустым заголовком должно вернуть ошибку
     *
     * Что проверяет этот тест:
     * - Сервер не позволяет создать заметку без заголовка
     * - Возвращается HTTP-код 400 (Bad Request - плохой запрос)
     * - В ответе есть понятное сообщение об ошибке
     *
     * Код 400 означает, что запрос клиента неправильный (валидация не прошла)
     */
    @Test // JUnit запустит этот метод как тест
    @DisplayName("Create note with empty title should return 400") // Название для отчёта
    public void createNoteWithEmptyTitleShouldFail() {

        // ШАГ 1: Подготавливаем некорректные данные - заметку БЕЗ заголовка
        // TestData.noteWithEmptyTitle() возвращает объект с пустым title
        NoteCreateRequest request = TestData.noteWithEmptyTitle();

        // ШАГ 2: Отправляем POST-запрос на создание заметки с некорректными данными
        // Используем метод createNoteResponse() вместо createNote(),
        // потому что ожидаем ошибку, а не успешный результат
        Response response = NotesClient.createNoteResponse(request);

        // ШАГ 3: ПРОВЕРКИ ответа сервера

        // Проверка 1: Сервер должен вернуть код 400 (Bad Request)
        // 400 = неправильный запрос, данные не прошли валидацию
        response.then()
                .statusCode(400)

                // Проверка 2: В ответе должно быть поле "message" с описанием ошибки
                // notNullValue() - проверяем, что сообщение об ошибке не пустое
                // Пользователь должен понять, что именно не так с его запросом
                .body("message", notNullValue());

        // Если сервер вернул 400 с сообщением - тест пройден!
        // Это значит, что валидация работает правильно
    }

    /**
     * ТЕСТ: Создание заметки с пустым описанием должно вернуть ошибку
     *
     * Что проверяет этот тест:
     * - Сервер не позволяет создать заметку без описания
     * - Возвращается HTTP-код 400 (Bad Request)
     * - В ответе есть сообщение об ошибке
     *
     * Этот тест аналогичен предыдущему, но проверяет валидацию поля description
     */
    @Test // Помечаем как тест
    @DisplayName("Create note with empty description should return 400") // Название для отчёта
    public void createNoteWithEmptyDescriptionShouldFail() {

        // ШАГ 1: Подготавливаем некорректные данные - заметку БЕЗ описания
        NoteCreateRequest request = TestData.noteWithEmptyDescription();

        // ШАГ 2: Отправляем некорректный запрос на сервер
        Response response = NotesClient.createNoteResponse(request);

        // ШАГ 3: ПРОВЕРКИ

        // Проверка 1: Код ответа должен быть 400
        response.then()
                .statusCode(400)

                // Проверка 2: Сообщение об ошибке должно присутствовать
                .body("message", notNullValue());

        // Если валидация описания работает - тест пройден!
    }

    /**
     * ТЕСТ: Получение заметки с несуществующим ID должно вернуть 404
     *
     * Что проверяет этот тест:
     * - Сервер корректно обрабатывает запрос заметки, которой не существует
     * - Возвращается HTTP-код 404 (Not Found - не найдено)
     * - В ответе есть сообщение об ошибке
     *
     * Код 404 означает, что запрошенный ресурс не найден на сервере
     */
    @Test // Помечаем как тест
    @DisplayName("Get note with invalid ID should return 404") // Название для отчёта
    public void getNoteWithInvalidIdShouldReturn404() {

        // ШАГ 1: Создаём заведомо несуществующий ID заметки
        // Такой ID точно не существует в базе данных
        String invalidId = "invalid-note-id-12345";

        // ШАГ 2: Пытаемся получить заметку с несуществующим ID
        Response response = NotesClient.getNoteResponse(invalidId);

        // ШАГ 3: ПРОВЕРКИ

        // Проверка 1: Сервер должен вернуть код 404 (Not Found)
        // 404 = ресурс не найден
        response.then()
                .statusCode(404)

                // Проверка 2: Должно быть сообщение об ошибке
                // Пользователь должен понять, что заметка не найдена
                .body("message", notNullValue());

        // Если сервер правильно обрабатывает несуществующий ID - тест пройден!
    }

    /**
     * ТЕСТ: Удаление несуществующей заметки должно вернуть 404
     *
     * Что проверяет этот тест:
     * - Попытка удалить несуществующую заметку не приводит к краху сервера
     * - Возвращается HTTP-код 404 (Not Found)
     * - В ответе есть сообщение об ошибке
     *
     * Эта ситуация может возникнуть, если:
     * - Пользователь дважды нажал кнопку "Удалить"
     * - Заметка была удалена другим пользователем
     * - Пользователь ввёл неправильный ID вручную
     */
    @Test // Помечаем как тест
    @DisplayName("Delete non-existent note should return 404") // Название для отчёта
    public void deleteNonExistentNoteShouldReturn404() {

        // ШАГ 1: Создаём заведомо несуществующий ID заметки
        String nonExistentId = "non-existent-note-id-99999";

        // ШАГ 2: Пытаемся удалить заметку, которой не существует
        Response response = NotesClient.deleteNoteResponse(nonExistentId);

        // ШАГ 3: ПРОВЕРКИ

        // Проверка 1: Должен вернуться код 404 (Not Found)
        response.then()
                .statusCode(404)

                // Проверка 2: Должно быть сообщение об ошибке
                .body("message", notNullValue());

        // Если сервер корректно обрабатывает удаление несуществующей заметки - тест пройден!
    }

    /**
     * ТЕСТ: Обновление несуществующей заметки должно вернуть 404
     *
     * Что проверяет этот тест:
     * - Попытка обновить несуществующую заметку не приводит к ошибкам сервера
     * - Возвращается HTTP-код 404 (Not Found)
     * - В ответе есть сообщение об ошибке
     *
     * Эта ситуация может возникнуть, если:
     * - Заметка была удалена до попытки обновления
     * - Пользователь ввёл неправильный ID
     * - Произошла рассинхронизация данных между клиентом и сервером
     */
    @Test // Помечаем как тест
    @DisplayName("Update non-existent note should return 404") // Название для отчёта
    public void updateNonExistentNoteShouldReturn404() {

        // ШАГ 1: Создаём заведомо несуществующий ID заметки
        String nonExistentId = "non-existent-note-id-88888";

        // ШАГ 2: Пытаемся обновить заметку, которой не существует
        // Передаём несуществующий ID и корректные данные для обновления
        Response response = NotesClient.updateNoteResponse(nonExistentId, TestData.updateNoteData());

        // ШАГ 3: ПРОВЕРКИ

        // Проверка 1: Должен вернуться код 404 (Not Found)
        // Нельзя обновить то, чего не существует
        response.then()
                .statusCode(404)

                // Проверка 2: Должно быть сообщение об ошибке
                .body("message", notNullValue());

        // Если сервер корректно обрабатывает обновление несуществующей заметки - тест пройден!
    }

    /*
     * ИТОГО: Все негативные тесты проверяют, что система:
     * 1. Не падает при неправильных действиях пользователя
     * 2. Возвращает правильные HTTP-коды ошибок (400 для неправильных данных, 404 для несуществующих ресурсов)
     * 3. Предоставляет понятные сообщения об ошибках
     *
     * Это обеспечивает хороший пользовательский опыт (UX) - пользователь всегда понимает,
     * что пошло не так, и может исправить свою ошибку.
     */
}
